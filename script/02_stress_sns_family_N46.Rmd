---
title: "SNS Index Stress Model w/ 3-Way Interaction | N = 46 | 5 min | Thresh = 1 \n | Activity_ML4 Classification | Parenting"
author: "Field Lab |  ACDC Lab"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    theme: united
    number_sections: true 
  pdf_document: 
    toc: true
header-includes:
   - \usepackage{amsmath}
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE, #prevents code, but not the results from appearing in the finished file
	message = FALSE, #prevents messages that are generated by code from appearing in the finished file
	warning = FALSE #prevents warnings that are generated by code from appearing in the finished file
)
```


----------

**Step 1: Generate  Stress/No-Stress Labels:** We generate Stress/No-Stress labels for each 5 min interval based on the SNS Index values and the psycho-physiological definition of stress as instantaneous hyperarousal.


**Step 2: Regress on Stress/No-Stress:** Using the Stress/No-Stress binary variable as the response variable, we run a model that provides explanations for the sources of participant stress.


----------

\newpage

```{r Libraries, include=FALSE}
library(tidyverse) # includes ggplot2 dplyr tidyr readr purrr tibble stringr forcats
library(latex2exp) # parses and converts LaTeX math formulas to R's plotmath expressions
library(ggpubr) # facilitates the creation of beautiful ggplot2-based graphs
library(arm)  # convenience functions for regression in R
library(jtools) # efficient presentation of regression analysis, e.g., summ() function
library(ggcorrplot) # visualize easily a correlation matrix using ggplot2
require(ggpmisc) # extension to ggplot2
library(cowplot) # extension to ggplot - arranging plots in a grid
library(hms) # pretty time of day

theme_set(theme_classic()) # set the theme to classic
theme_update(plot.title = element_text(hjust = 0.5)) # center the title

rm(list = ls())
dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(dir)
getwd()
```


```{r SpecialThemes, message=FALSE, warning=FALSE}
# load the utility script
source("../script/utility_script.R")

options(digits=3)

data_dir = "../data/" # data directory
plot_dir = "../figures/" # plot directory
```



```{r ReadData, include=FALSE}
# Load the data
file_name = "Activity_Stress_data_N46.csv"
data_full_path = paste0(data_dir, file_name)
df = read.csv(data_full_path, stringsAsFactors = T)

#remove Participant T031 as it has no full 4 day data

df <- df %>%
  filter(!Participant %in% c("T031")) %>%
  droplevels()

str(df)


colSums(is.na(df))
unique(df$Activity_ML4)
df$Activity_ML4 = as.character(df$Activity_ML4)

#remove unknown activity which is not used in the analysis
df <- df %>%
  filter (Activity_ML4!= "Unknown" & Activity_ML4 != "Sleep")
unique(df$Activity_ML4)

# reunion of the two WD1 and WD2 days as WD.
df$Day <- recode_factor(df$Day,
                                  "WD1" = "WD", "WD2" = "WD", 
                                  "CD" = "CD", "ND" = "ND"
)

df$Day = factor(df$Day, levels = c("CD", "WD", "ND"))


df$PA_Activity <- NA 

df$PA_Activity = as.character(df$PA_Activity)

df[df$Activity_ML4 == "Work",]$PA_Activity =  "Sedentary"
df[df$Activity_ML4 == "NonWork",]$PA_Activity =  "Sedentary"
df[df$Activity_ML4 == "Driving",]$PA_Activity =  "Sedentary"

df[df$Activity_ML4 == "PA",]$PA_Activity =  "PA"


unique(df$PA_Activity)


df$PA_Activity = factor(df$PA_Activity, levels = c("Sedentary", "PA"))
# recode activities slow to fast.
df$Activity_ML4 = factor(df$Activity_ML4, levels = c("Work", "NonWork", "Driving", "PA"))

# create sedentary data
df_sedentMultimodal = df %>%
  filter(Activity_ML4 %in% c("Work", "NonWork", "Driving")) %>%
  droplevels()
# recode the activities in the sedentary data
df_sedentMultimodal$Activity_ML4 = factor(df_sedentMultimodal$Activity_ML4, levels = c("Work", "NonWork", "Driving"))

df_sedentMultimodal <- df_sedentMultimodal %>%
  drop_na(SNS_Stress) %>%
  droplevels() %>%
  ungroup()

str(df_sedentMultimodal)
df_sedentMultimodal$Relstatus
```




# Physical Acitvity (PA) Per Participant & Day
```{r PhysicalActivityComputations, echo=FALSE}
library(psych)

# Calculate PA_Percent
PA_Percent_Summary <- df %>% 
  group_by(Participant, Day) %>%
  summarise(nT = sum(Activity_ML4 == "Work"| Activity_ML4 == "NonWork"| Activity_ML4 == "Driving"| 
                    Activity_ML4 == "PA" , na.rm = TRUE), 
            PA_Percent = sum(Activity_ML4 == "PA",
                             na.rm = TRUE) *100 / nT )  %>%
  ungroup() %>%
  mutate(total_n = sum(nT)) # add df len with

PA_Percent_Summary = PA_Percent_Summary %>% # remove the n_total column
  dplyr::select(-total_n) 

# Calculate PA_Intensity
PA_Intensity_Summary = df %>%
  group_by(Participant, Day) %>%
  #filter(Activity_ML4 %in% c("Walking", "Running", "Biking")) %>%
  filter(Activity_ML4 %in% c("PA")) %>%
  summarise(
    PA_Intensity = round(mean(Cadence, na.rm=TRUE),1) # mean Cadence per day per subject
  ) 

All_Summary = merge(PA_Percent_Summary, PA_Intensity_Summary, by = c("Participant", "Day"), all.x = T) 

All_Summary 

psych::describe(All_Summary )

detach("package:psych", unload=TRUE)
```

# Frequencies of Sedentary Activities Per Day and Participant and remove NAs in SNS_Stress
```{r StressThresholdComputations}
colSums(is.na(df_sedentMultimodal))

# remove rows with NA in SNS_Stress
df_sedentMultimodal <- df_sedentMultimodal %>%
  drop_na(SNS_Stress)
# table of sedentary activities per day and participant
df_sedentMultimodal$SNS_Stress <- as.factor(df_sedentMultimodal$SNS_Stress)
table(df_sedentMultimodal$Participant, df_sedentMultimodal$Activity_ML4, df_sedentMultimodal$Day)
```

# Distrubution of SNS Index in Sedentary Activities
```{r SNSindex_pdf}
df_sedentMultimodal %>%
  ggplot(aes(x = SNSindex, fill = Activity_ML4)) +
  geom_density(alpha = 0.5) +
  my_theme1 +
  theme(legend.position = "top") +
  guides(fill=guide_legend("Activity")) +
  labs(x = TeX(r'(SNS Index)'),
       y = "PDF") 
```

# Viz of Stress Distribution and QQ Plots for T010
```{r Stress_Threshold_Viz_t010, echo=FALSE, fig.height=7, fig.width=7}
# Create a complete grid of Participant and Day combinations
complete_grid <- expand_grid(
  Participant = sprintf("T%03d", 1:25), 
  Day = c("CD", "WD", "ND")
)

complete_grid$Day = factor(complete_grid$Day, levels = c("CD", "WD", "ND"))

# Ensure all combinations are present in the data
df_sedentMultimodalForm <- complete_grid %>%
  left_join(df_sedentMultimodal, by = c("Participant", "Day"))

df_sedentMultimodalFormTmp = df_sedentMultimodalForm %>% 
 filter(Participant %in% sprintf("T%03d", 10) )

# T010
 plot_stress_distr <- df_sedentMultimodalFormTmp %>%
 ggplot(aes(x = SNSindex, fill = SNS_Stress)) +
 scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
 geom_histogram( position = "dodge", binwidth = 0.1) +
 facet_wrap(~Participant+Day, ncol = 3) +
 my_theme1 +
 scale_x_continuous(breaks = seq(-10, 20, by = 5)) +
 theme(legend.position = "none") +
 labs(x = TeX(r'(SNS Index)'), y = "Frequency") +
 geom_vline(aes(xintercept = SNSindexThreshold), color = "blue", linetype = 3, linewidth = 0.5) 

# Create qq plots for T010 of Day
plot_stress_qq <- df_sedentMultimodalFormTmp %>%
  ggplot(aes(sample = SNSindex)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3) +
  theme(legend.position = "none")

plot_stress_label <- cowplot::plot_grid(plot_stress_distr, plot_stress_qq, label_size = 8,
                   labels = c("b1","b2"), ncol = 1, nrow = 2)

plot_stress_label

plot_file = paste0(plot_dir, "SNS-Stress-Label-Plots-T010.pdf")
ggsave(plot_file, plot_stress_label, width = 4.0, height = 4.0, dpi = 300)

library(psych)

df_sedentMultimodalForm %>%
  ungroup() %>%
  filter(Participant %in% sprintf("T%03d", 10) ) %>%
  group_by(Day) %>%
  dplyr::select(Participant,Day, SNSindex, PA_Percent, PA_Intensity) %>%
  distinct() %>%
  ungroup() %>%
  psych::describe()

detach("package:psych", unload=TRUE)
```

# PA_Percent Plot
```{r PA_Percent_Plot, echo=FALSE, message=FALSE, warning=FALSE}
library(psych)

df_sedentMultimodal %>%
  group_by(Participant, Day) %>% drop_na(SNSindex) %>%
  mutate(n_sedent = sum(Activity_ML4 == "Work"| Activity_ML4 == "NonWork"| Activity_ML4 == "Driving", na.rm = TRUE),
         n_stress = sum(SNS_Stress == "S", na.rm = TRUE),
         ) %>%
  dplyr::select(Participant, Day, n_sedent, n_stress, SNS_S, PA_Percent) %>%
  distinct()

plot_PA_Percent = df_sedentMultimodal %>%
  group_by(Participant, Day) %>%
  dplyr::select(Participant, Day, Date, PA_Percent) %>%
  distinct() %>%
ggplot(aes(x = Day, y = PA_Percent/100, fill = Day)) +
geom_boxplot() +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "", y = TeX(r'($\textit{PA}_{pc}$)'), title = "") +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -2.00, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

plot_PA_Percent

detach("package:psych", unload=TRUE)
```


\newpage

# Big 5 Box Plots
```{r echo=FALSE, fig.height=5, fig.width=7, message=FALSE, warning=FALSE}

Profession = df_sedentMultimodal %>% 
  group_by(Profession) %>%
  dplyr::select(Participant, Profession) %>% drop_na() %>%
  distinct() 
  


big5_df = df_sedentMultimodal %>%
  dplyr::select(Participant, Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness) %>%
  drop_na() %>%
  distinct() %>%
  mutate(
    Participant = as.character(Participant),
    Agreeableness = as.numeric(Agreeableness),
    Conscientiousness = as.numeric(Conscientiousness),
    Extraversion = as.numeric(Extraversion),
    Neuroticism = as.numeric(Neuroticism),
    Openness = as.numeric(Openness)
  ) %>%
  dplyr::select(Participant, Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness) 

xo = c("~bolditalic(B5[A])", "~bolditalic(B5[C])", "~bolditalic(B5[E])", "~bolditalic(B5[N])", "~bolditalic(B5[O])")
# library(psych)
# describe(big5_df)
# detach("package:psych", unload=TRUE)

All_big5_plots = big5_df %>%
pivot_longer(cols = -c("Participant"), names_to = "Big5", values_to = "Score") %>%
ggplot(aes(x = Big5, y = Score)) +
geom_boxplot(fill = "white") +
scale_x_discrete(labels = parse(text=xo))+
scale_y_continuous(breaks = seq(2, 10, by = 2)) +
my_theme1 +
labs(x = "", y = "Big-Five Scores")+
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -0.1, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

print(All_big5_plots)


```

# Cadence PDF
```{r Cadence_Plot}
library(psych)

plot_cadence_pdf <- df %>% filter(!is.na(Cadence)) %>%
  filter(!is.na(PA_Activity)) %>%
  ggplot(aes(x = Cadence, fill = PA_Activity)) +
  geom_density(alpha = 0.6) +
  theme(legend.position = "top") +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold")) +
  theme(legend.title = element_text(size = 5), 
               legend.text = element_text(size = 5)) +
  theme(legend.key.size = unit(0.4, "cm")) +
   labs(x = TeX(r'($\textit{CDN} \ \[CPM\]$)'),
       y = "PDF",
       fill = ""
       ) +theme(legend.position = c(0.8, 0.8), #"top",
                  legend.box.margin = margin(0, -1, 0, 0))

#print(plot_cadence_pdf)

# df %>% filter(!is.na(Cadence)) %>%
#  filter(PA_Activity == "Sedentary") %>%   filter(!is.na(PA_Activity)) %>% describe()
# 
# df %>% filter(!is.na(Cadence)) %>%
#  filter(PA_Activity == "PA") %>%   filter(!is.na(PA_Activity)) %>% describe()

detach("package:psych", unload=TRUE)
```

\newpage

# Profession and Gender Plot
```{r Profession_Plot, eval=FALSE, fig.height=5, fig.width=5, include=FALSE}
prof.plot <- df_sedentMultimodal %>%
  ungroup() %>%
  dplyr::select(Participant, Profession) %>%   drop_na() %>%
  group_by(Profession) %>%
  distinct() %>%
  count() %>%
  ungroup() %>%
  mutate(
    sum_n = sum(n),
    prop = n / sum_n 
  ) %>%
  ggplot(aes(x = Profession, y = prop, fill = Profession)) +
  geom_bar(stat = "identity",  fill = c("coral1", "darkturquoise")) +
    scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label = n),
            vjust = 1.6,
            color = "black",
            size = 5) +
  labs(x = "", y = "", title = " Profession Distribution") +
  my_theme1 

prof.plot
# gender.plot

gender.plot <- df_sedentMultimodal %>%
  ungroup() %>%
  dplyr::select(Participant, Gender) %>%   drop_na() %>%
  group_by(Gender) %>%
  distinct() %>%
  count() %>%
  ungroup() %>%
  mutate(
    sum_n = sum(n),
    prop = n / sum_n 
  ) %>%
  ggplot(aes(x = Gender, y = prop, fill = Gender)) +
  geom_bar(stat = "identity",  fill = c("coral1", "darkturquoise")) +
    scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label = n),
            vjust = 1.6,
            color = "black",
            size = 5) +
  labs(x = "", y = "", title = " Gender Distribution") +
  my_theme1 

gender.plot
```

# Sleep Duration PDF
```{r SLEEP}
library(psych)

Sleep_df <- df_sedentMultimodal %>%
  dplyr::select(Participant, Day, Sleep_Time) %>%
  distinct()

Sleep_Plot = Sleep_df  %>%
  filter(!is.na(Sleep_Time)) %>%
  #distinct() %>%
  ggplot(aes(x=Sleep_Time)) +
  geom_density(fill = "gray") +
  labs(x = TeX(r'($\textit{SLEEP} \ \[hr\]$)'),
       y = "PDF"
       ) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"))

#Sleep_Plot

detach("package:psych", unload=TRUE)
```

# mCadence Plot
```{r echo=FALSE}
library(psych)

# describe(df_sedentMultimodal)

mCadence_p1 = df_sedentMultimodal %>%
  ggplot(aes(x=Cadence)) +
  geom_density(fill = "black") +
  my_theme1 +
  theme(legend.position = "top") +
   labs(x = TeX(r'($\textit{mCDN} \ \[CPM\]$)'),
       y = "PDF",
       fill = ""
       ) +theme(legend.position = c(0.8, 0.8), #"top",
                  legend.box.margin = margin(0, -1, 0, 0))

#mCadence_p1

detach("package:psych", unload=TRUE)
```



# Correlation Plot
```{r Collinearity_Plot, include=FALSE}
df_sedentMultimodal$Activity_ML4 <-factor(df_sedentMultimodal$Activity_ML4, levels = c("Work","NonWork","Driving"))
df_sedentMultimodal$Day <- relevel(df_sedentMultimodal$Day, ref = "CD")
df_sedentMultimodal$Period <- factor(df_sedentMultimodal$Period, levels =c("Morning","Afternoon"))

# df_sedentMultimodal = merge(df_sedentMultimodal, big5_df, by.x = c("Participant", "Profession"), by.y  = c("ID", "Profession"), x.all = TRUE)
```

```{r fig.height=11, fig.width=11, message=FALSE, warning=FALSE}
library(ggtext)
library(psych)

reduced_data <- subset(df_sedentMultimodal, 
                       select = c(Day, Period, Activity_ML4, Cadence,PA_Percent, PA_Intensity, 
                                  Sleep_Time, Profession,
                                  N_MD, N_PD, N_TD, N_P, N_E, N_F,
                                  Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness))


reduced_data = rename(reduced_data, c(
"DAY" = "Day", 
"PRD" = "Period",
"ACT" = "Activity_ML4", 
"PA_pc" = "PA_Percent", 
"PA_int" = "PA_Intensity", 
"SLEEP" = "Sleep_Time", 
"OCC" = "Profession",
"NASA_MD" = "N_MD", 
"NASA_PD" = "N_PD", 
"NASA_TD" = "N_TD", 
"NASA_P" = "N_P",
"NASA_E" = "N_E", 
"NASA_F" = "N_F", 
"B5_A" = "Agreeableness", 
"B5_C" = "Conscientiousness",
"B5_E" = "Extraversion", 
"B5_N" = "Neuroticism",
"B5_O" = "Openness"))

correlation_plot2 <- model.matrix(~., data=reduced_data)
correlation_plot <- cor((correlation_plot2), use="everything") 
colnames(correlation_plot) <- c("Intercept", "*DAY* &nbsp; [WD]", "*DAY* &nbsp; [ND]", "*PRD* &nbsp; [AFN]", "*ACT* &nbsp; [NonWork]", "*ACT* &nbsp; [Driving]", "*CDN*", "*PA<sub>pc</sub>*", "*PA<sub>int</sub>*", "*SLEEP*", "*OCC* &nbsp; [SP]", "*NASA<sub>MD</sub>*", "*NASA<sub>PD</sub>*", "*NASA<sub>TD</sub>*", "*NASA<sub>P</sub>*", "*NASA<sub>E</sub>*", "*NASA<sub>F</sub>*", "*B5<sub>A</sub>*", "*B5<sub>C</sub>*", "*B5<sub>E</sub>*", "*B5<sub>N</sub>*", "*B5<sub>O</sub>*")
rownames(correlation_plot) <- c("Intercept", "*DAY* &nbsp; [WD]", "*DAY* &nbsp; [ND]", "*PRD* &nbsp; [AFN]", "*ACT* &nbsp; [NonWork]", "*ACT* &nbsp; [Driving]", "*CDN*", "*PA<sub>pc</sub>*", "*PA<sub>int</sub>*", "*SLEEP*", "*OCC* &nbsp; [SP]", "*NASA<sub>MD</sub>*", "*NASA<sub>PD</sub>*", "*NASA<sub>TD</sub>*", "*NASA<sub>P</sub>*", "*NASA<sub>E</sub>*", "*NASA<sub>F</sub>*", "*B5<sub>A</sub>*", "*B5<sub>C</sub>*", "*B5<sub>E</sub>*", "*B5<sub>N</sub>*", "*B5<sub>O</sub>*")

corr.plot <- (ggcorrplot(correlation_plot, show.diag=FALSE, type="lower", lab=TRUE) + theme(axis.text = element_markdown()))

corr.plot

plot_file = paste0(plot_dir, "SNS-Stress-Correlation-Plot.pdf")
ggsave(plot_file, corr.plot, width = 11.0, height = 11.0, dpi = 300)

library(data.table) 
  
set.seed(1) 
  
# counting frequencies of factor 
# levels 
setDT(reduced_data)[, .N, keyby=ACT] 

detach("package:psych", unload=TRUE)




```


Create participant level kids table
```{r Kids_Table1, echo=FALSE, message=FALSE, warning=FALSE}


df_kids = df_sedentMultimodal %>%
  dplyr::select(Participant, Kids) %>%
  distinct()

table(df_kids$Kids)
```


\newpage

# Full Logistic Regression Mixed Effects Model (Stress from SNS)


### Add Kids [No/Yes]
```{r echo=FALSE, message=FALSE, warning=FALSE}


df_sedentMultimodal$Period <- factor(df_sedentMultimodal$Period, levels =c("Morning","Afternoon"))


stress_logit_model = glmer(SNS_Stress ~  Cadence + Day*Period + Activity_ML4 + Day*PA_Percent* PA_Intensity + Sleep_Time + Profession + N_MD + N_PD + N_P + Agreeableness + Conscientiousness + Extraversion + Neuroticism + Openness +  Day*Kids  + (1 | Participant), data = df_sedentMultimodal, family = binomial(link = "logit"))


summary(stress_logit_model)
summ(stress_logit_model, digits=3)
```




```{r Full_LRM, eval=FALSE, warning=FALSE, include=FALSE}
# Fit the model
## PA_Intensity has 23 subjects, T008 all days have NA for PA_Intensity

library(sjPlot)
library(sjmisc)
# names(df_sedentMultimodal)

# stress_logit_model = glmer(SNS_Stress ~  Cadence + Day*Period + Activity_ML4 + Day*PA_Percent*PA_Intensity + Sleep_Time + Profession + N_MD + N_PD + N_P + Agreeableness + Conscientiousness + Extraversion + Neuroticism + Openness + (1 | Participant), data = df_sedentMultimodal, family = binomial(link = "logit"))



#show random effects
ranef(stress_logit_model)

m.plot.main1 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Cadence[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                    labs(x = TeX(r'($\textit{mCDN} \ \[CPM\]$)'), 
                         y = TeX(r'($\textit{P(S)}$)'))

m.plot.main2 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.title.x = element_blank(), 
                         axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                   labs(x = "",
                        y = TeX(r'($\textit{P(S)}$)'))

m.plot.main3 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Activity_ML4[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.title.x = element_blank(), 
                         axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                    labs(x = "",
                         y = TeX(r'($\textit{P(S)}$)'))

m.plot.main4 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("N_MD[all]"),
                   colors = "red") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                   labs(x = TeX(r'($\textit{NASA_{MD}}$)'), 
                        y = TeX(r'($\textit{P(S)}$)'))

m.plot.main5 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("N_PD[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                   labs(x = TeX(r'($\textit{NASA_{PD}}$)'),
                        y = TeX(r'($\textit{P(S)}$)'))

m.plot.main6 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("N_P[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                    labs(x = TeX(r'($\textit{NASA_{P}}$)'),
                         y = TeX(r'($\textit{P(S)}$)'))

m.plot.main7 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Extraversion[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                   labs(x = TeX(r'($\textit{B5_{E}}$)'),
                        y = TeX(r'($\textit{P(S)}$)'))

m.plot.2way <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]", "Period[all]")) +
                   theme_bw() +
                   theme(axis.title.x = element_blank(),
                         axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                    labs(x = "",
                         y = TeX(r'($\textit{P(S)}$)'))

m.plot.3way <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]", "PA_Percent[4.43, 17.68]", "PA_Intensity")) +
                   theme_bw() +
                   theme(axis.title.x = element_blank(),
                         axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                    labs(x = "",
                         y = TeX(r'($\textit{P(S)}$)'))

m.plot.main1

m.plot.main2

m.plot.main3

m.plot.main4

m.plot.main5

m.plot.main6

m.plot.main7

m.plot.2way

m.plot.3way
```

# Remove Neuroticism from the Model
```{r Optimized_Model1, echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model1 = glmer(SNS_Stress ~  Cadence + Day*Period + Activity_ML4 + Day*PA_Percent* PA_Intensity + Sleep_Time + Profession + N_MD + N_PD + N_P + Agreeableness  + Extraversion + Conscientiousness + Openness +  Day*Kids  + (1 | Participant), data = df_sedentMultimodal, family = binomial(link = "logit"))

summary(stress_logit_model1)
summ(stress_logit_model1, digits=4)
```


# Optimal and Scaled Model
```{r Optimal_Scaled_Model}
df_sedentMultimodal$s_Cadence <- scale(df_sedentMultimodal$Cadence)
df_sedentMultimodal$s_PA_Percent <- scale(df_sedentMultimodal$PA_Percent)
df_sedentMultimodal$s_PA_Intensity <- scale(df_sedentMultimodal$PA_Intensity)
df_sedentMultimodal$s_Sleep_Time <- scale(df_sedentMultimodal$Sleep_Time)
df_sedentMultimodal$s_N_MD <- scale(df_sedentMultimodal$N_MD)
df_sedentMultimodal$s_N_PD <- scale(df_sedentMultimodal$N_PD)
df_sedentMultimodal$s_N_P <- scale(df_sedentMultimodal$N_P)
df_sedentMultimodal$s_Agreeableness <- scale(df_sedentMultimodal$Agreeableness)
df_sedentMultimodal$s_Extraversion <- scale(df_sedentMultimodal$Extraversion)
df_sedentMultimodal$s_Neuroticism <- scale(df_sedentMultimodal$Neuroticism)
df_sedentMultimodal$s_Openness <- scale(df_sedentMultimodal$Openness)
df_sedentMultimodal$s_Conscientiousness <- scale(df_sedentMultimodal$Conscientiousness)


stress_logit_model_s = glmer(SNS_Stress ~  s_Cadence + Day*Period + Activity_ML4 + 
Day*s_PA_Percent* s_PA_Intensity + s_Sleep_Time + Profession + s_N_MD + s_N_PD + s_N_P + s_Agreeableness + s_Extraversion + s_Conscientiousness + s_Openness +  Day*Kids  + (1 | Participant), data = df_sedentMultimodal, family = binomial(link = "logit"))



summary(stress_logit_model_s)
summ(stress_logit_model_s, confint = TRUE, digits=3)
```

&nbsp;
\newpage
# Visualization of SNS Stress Model 

```{r echo=FALSE, fig.height=4.5, fig.width=7}
library(ggeffects)

m.plot.main_cdn <-  ggpredict(stress_logit_model_s, "s_Cadence[all]") %>%
  ggplot(aes(x, predicted)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  geom_line(colour = "red", size = 2) +
  geom_vline(
    xintercept = mean(df_sedentMultimodal$s_Cadence, na.rm = TRUE),
    linetype = "dashed",
    color = "gray",
    size = 1
  ) +   my_theme3 + 
  coord_cartesian(ylim = c(0.1, 1)) + 
  scale_y_continuous(labels = scales::percent) +
  #remove y axis labels
  labs(x = TeX(r'($\textit{mCDN} \ \[Scaled\]$)'), y = TeX(r'($\textit{P(S)}$)'))

#m.plot.main_cdn 

library(sjPlot)
library(sjmisc)


m.plot.main_act <- ggpredict(stress_logit_model_s,
  terms = c("Activity_ML4")) %>%
  mutate(group = as.factor(c("1", "2", "3"))) %>%
  drop_na() %>%
  gather(key = "key", value = "value", conf.low, conf.high) %>%
  ggplot() +
  geom_line(aes(x = x, y = value, color = group), size = 2) +
  geom_point(aes(x = x, y = predicted, color = group, size = 2)) +
  scale_color_manual(values = c("gray", "red", "red")) +
  coord_cartesian(ylim = c(0.1, 1)) +  
  my_theme3 + 
  scale_x_discrete(labels = c("WRK", TeX(r'($\neg$WRK)'), "DRV")) +
  scale_y_continuous(labels = scales::percent)  +
  labs(x = "", y = "") + theme(axis.text.y = element_blank()) 

#m.plot.main_act

m.plot.main_nmd <- ggpredict(stress_logit_model_s, "s_N_MD[all]") %>%
    ggplot(aes(x, predicted)) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
    geom_line(colour = "red", size = 2) +
    geom_vline(
     xintercept = mean(df_sedentMultimodal$Ps_N_MD),
     linetype = "dashed",
     color = "gray",
     size = 1
   ) +  my_theme3 + coord_cartesian(ylim = c(0.1, 1)) +  
   scale_y_continuous(labels = scales::percent) +
   labs(x = TeX(r'($\textit{NASA_{MD}}$)'), y = "") + theme(axis.text.y = element_blank()) 

#m.plot.main_nmd

m.plot.2way <- sjPlot::plot_model(stress_logit_model_s,
                   type = "pred",
                   colors = c("coral", "blue"),
                   axis.title = TeX(r'($\textit{P(S)}$)'),
                   terms = c("Day[all]", "Period[all]")) +
                   set_theme (
                     base = my_theme3,
                     legend.pos = "bottom") +
                   theme(axis.title.x = element_blank(),
                     axis.text = element_text(size = 10),
                     panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank()) +
                    labs(x = "", y = "", title = "")   +
  scale_y_continuous(labels = scales::percent) +
  labs(x ="", y = TeX(r'($\textit{P(S)}$)'))

#m.plot.2way

m.plot.3way <- sjPlot::plot_model(stress_logit_model_s,
                   type = "pred",
                   colors = c("coral", "blue"),
                   axis.title = TeX(r'($\textit{P(S)}$)'),
                   legend.title="Scaled PA Extent",
                   terms = c("Day[all]", "s_PA_Percent[-1, 1]", "s_PA_Intensity[-1, 1]")) +
                   set_theme (
                     base = my_theme3,
                     legend.pos = "bottom") +
                   theme(axis.title.x = element_blank(),
                     axis.text = element_text(size = 10),
                     panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank()) +
                    labs( title = "") +
  scale_y_continuous(labels = scales::percent)  +
  labs(x ="", y = TeX(r'($\textit{P(S)}$)'))

m.plot.3way$data$facet <- factor(m.plot.3way$data$facet)
#levels(m.plot.3way$data$facet)  <- c("PA Intensity = -1", "PA Intensity = 1")

#m.plot.3way


m.plot.kids2way <- sjPlot::plot_model(stress_logit_model_s,
                   type = "pred",
                   colors = c("coral", "blue"),
                   terms = c("Day[all]", "Kids[all]")) +
                   set_theme (
                     base = my_theme3,
                     legend.pos = "bottom") +
                   theme(axis.title.x = element_blank(),
                     axis.text = element_text(size = 10),
                     panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank()) +
                    labs( title = "") +
  coord_cartesian(ylim = c(0.1, 1.0)) + 
  scale_y_continuous(labels = scales::percent)  +
  labs(x ="", y = TeX(r'($\textit{P(S)}$)'))

m.plot.kids2way

```

&nbsp;

# Composite Model Figure
```{r Composite_Model_Figure, echo=FALSE, fig.height=11, fig.width=7, message=FALSE, warning=FALSE}

p_a <- cowplot::plot_grid(
  m.plot.2way,
  nrow = 1,
  scale = c(.97),
  labels = c("b1"),
  label_size = 13
) 

p_e <- cowplot::plot_grid(
  m.plot.3way,
  nrow = 1,
  scale = c(.97),
  labels = c("b2"),
  label_size = 13
) 

p_bcd <- cowplot::plot_grid(
  m.plot.main_cdn, m.plot.main_act, m.plot.main_nmd,
  nrow = 1,
  scale = c(0.97, .97, .97),
  labels = c("b3", "b4", "b5"),
  label_size = 13,
  label_y = 1.05    # move labels vertically above the plots
)


p_kids <- cowplot::plot_grid(m.plot.kids2way,
                          nrow = 1,
  scale = c(.97),
  labels = c("b6"),
  label_size = 13
)

final.w.legend <- cowplot::plot_grid(p_a, p_e, p_bcd, mylegend, p_kids,  
  nrow = 5,   
  scale = c(0.97, .97, .97, .1, .97),
  rel_heights = c(3.0, 3.0, 3.0, 0.3, 3.0)
)

final.w.legend

# save the plot
plot_file = paste0(plot_dir, "SNS-Stress-Model-Plots.pdf")
ggsave(plot_file, final.w.legend, width = 5.5, height = 10, dpi = 300)

levels(df_sedentMultimodal$Participant)
```

#  SNS  Model Table

```{r Valence-table3, echo=FALSE}

# 1) Put your models in a named list
models_valence <- list(
  SNS = stress_logit_model_s
)

#mod= models_valence[["Happy"]]
# 2) extract each summary(...$coefficients) into a data.frame
coef_dfs_valence <- lapply(models_valence, function(mod) {
  co <- summ(mod, digits = 3)$coeftable
  as.data.frame(co, stringsAsFactors = FALSE)
})

all_preds_valence <- unique(unlist(lapply(coef_dfs_valence, rownames)))



# assume coef_dfs is your list of 4 data.frames,
# each with rownames = predictor names and columns Est., S.E., t val., d.f., p

aligned_valence <- lapply(coef_dfs_valence, function(df) {
  df2 <- as.data.frame(df, stringsAsFactors=FALSE)
  df2$Predictor <- rownames(df2)

  # reorder (and insert NA rows for missing preds)
  df2 <- df2[match(all_preds_valence, df2$Predictor), , drop=FALSE]

  # restore rownames
  rownames(df2) <- all_preds_valence
  df2
})

# 3) drop the extra Predictor columns except in the first
for(i in seq_along(aligned_valence)) {
  aligned_valence[[i]]$Predictor <- NULL
}

# 4) now cbind them
merged_valence <- do.call(cbind, aligned_valence)

# 5) restore a single Predictor column in front
merged_valence <- cbind(Predictor = rownames(merged_valence), merged_valence, row.names=NULL)


# Select all columns that end with ".Est." and drop them
Est_all <- merged_valence %>% dplyr::select(Predictor,ends_with(".Est."))
SE_all <- merged_valence %>% dplyr::select(Predictor,ends_with(".S.E."))
t_all <- merged_valence %>% dplyr::select(Predictor,ends_with(".z val."))
p_all <- merged_valence %>% dplyr::select(Predictor,ends_with(".p"))



paper_merged <- cbind(Est_all, SE_all[, -1], t_all[, -1], p_all[, -1])
#paper_merged <- cbind(Est_all, SE_all, t_all, p_all)

paper_merged <- dplyr::bind_cols(
  Est_all,
  SE_all %>% dplyr::select(-Predictor),
  t_all %>% dplyr::select(-Predictor),
  p_all %>% dplyr::select(-Predictor)
)


#round 3 digits
paper_merged %>%
  mutate(across(ends_with(".p"), ~ format.pval(., digits = 2, eps = 0.001))) %>%
  mutate(across(ends_with(".Est."), ~ round(., 3))) %>%
  mutate(across(ends_with(".S.E."), ~ round(., 3))) %>%
  mutate(across(ends_with(".z val."), ~ round(., 3))) -> paper_merged

print(paper_merged)
```

